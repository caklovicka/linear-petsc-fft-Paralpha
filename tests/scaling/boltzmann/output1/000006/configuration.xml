<?xml version="1.0" encoding="UTF-8"?>
<jube version="2.5.1">
  <benchmark name="PETSc-Euler scaling test" file_path_ref="../.." outpath="..">
    <comment>Boltzmann k = 1e-2, parallel in time, NOT exit()parallel in space (PinT/n)</comment>
    <parameterset name="param_set" duplicate="replace">
      <parameter name="i" type="int" separator="," duplicate="none" mode="text">0,1,2,3,4</parameter>
      <parameter name="proc_col" type="int" separator="," duplicate="none" mode="text">1</parameter>
      <parameter name="nodes" type="string" separator="," duplicate="none" mode="python">[1, 1, 1, 1, 1][$i]</parameter>
      <parameter name="rolling" type="string" separator="," duplicate="none" mode="python">[16, 8, 4, 2, 1][$i]</parameter>
      <parameter name="time_intervals" type="string" separator="," duplicate="none" mode="python">[2, 4, 8, 16, 32][$i]</parameter>
      <parameter name="nproc" type="string" separator="," duplicate="none" mode="python">$proc_col * $time_intervals</parameter>
    </parameterset>
    <substituteset name="substitute">
      <iofile in="batch1.tmpl" out="run.exe" out_mode="w"/>
      <sub source="#nproc#">$nproc</sub>
      <sub source="#nodes#">$nodes</sub>
      <sub source="#proc_col#">$proc_col</sub>
      <sub source="#rolling#">$rolling</sub>
      <sub source="#time_intervals#">$time_intervals</sub>
    </substituteset>
    <fileset name="files">
      <copy>boltzmann1.py</copy>
      <copy>batch1.tmpl</copy>
    </fileset>
    <patternset name="pattern">
      <pattern name="tot_time" type="float" dotall="False" mode="pattern">algorithm time = $jube_pat_fp</pattern>
      <pattern name="comm_time" type="float" dotall="False" mode="pattern">communication time = $jube_pat_fp</pattern>
      <pattern name="max_iters" type="float" dotall="False" mode="pattern">max iterations of paradiag = $jube_pat_fp</pattern>
      <pattern name="tot_iters" type="float" dotall="False" mode="pattern">total iterations of paradiag = $jube_pat_fp</pattern>
      <pattern name="tol" type="float" dotall="False" mode="pattern">tol = $jube_pat_fp</pattern>
      <pattern name="stol" type="float" dotall="False" mode="pattern">inner solver tol = $jube_pat_fp</pattern>
      <pattern name="Nx" type="int" dotall="False" mode="pattern">no. of spatial points = \[$jube_pat_int</pattern>
      <pattern name="convergence" type="int" dotall="False" mode="pattern">convergence = $jube_pat_int</pattern>
      <pattern name="Nt" type="int" dotall="False" mode="pattern">no. of time intervals = $jube_pat_int</pattern>
      <pattern name="dt" type="float" dotall="False" mode="pattern">dt = $jube_pat_fp</pattern>
    </patternset>
    <step name="sub_step">
      <use>param_set</use>
      <use>files</use>
      <use>substitute</use>
      <do done_file="ready">sbatch -A cstma run.exe</do>
    </step>
    <analyser name="analyse" reduce="True">
      <use>pattern</use>
      <analyse step="sub_step">
        <file>scaling_petsc1.out</file>
      </analyse>
    </analyser>
    <result>
      <use>analyse</use>
      <table name="result" style="pretty" separator="," transpose="False">
        <column>nproc</column>
        <column>proc_col</column>
        <column>rolling</column>
        <column>time_intervals</column>
        <column>tot_time_avg</column>
        <column>comm_time_avg</column>
        <column>max_iters</column>
        <column>tot_iters</column>
        <column>Nx</column>
        <column>Nt</column>
        <column>dt</column>
        <column>stol</column>
        <column>tol</column>
        <column>convergence</column>
      </table>
    </result>
  </benchmark>
</jube>
